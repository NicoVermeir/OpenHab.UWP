name: 'Create Release Package'

env:
  BUILD_NUMBER: '1970.1.1'
  build_directory: '${{github.workspace}}\build\'

on: workflow_dispatch

jobs:
  build:
    name: 'Build openHAB Windows App'
    runs-on: windows-latest
    needs: test

    steps:
    - name: Checkout main code
      uses: actions/checkout@v2
      with:
        path: src
        clean: true 

    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.0.5
      with:
        nuget-version: 'latest'

    - name: setup-msbuild
      uses: microsoft/setup-msbuild@v1

    - name: Build App
      id: create_app_package
      uses: ./src/.github/workflows/actions/app-build
      with:
        build_configuration: 'release'
        output_directory: '${{env.build_directory}}'

    - name: Upload build assets
      uses: actions/upload-artifact@v2.2.2
      with:
        name: app
        path: '${{env.build_directory}}'
      
  release:
      name: 'Creates an app release'
      runs-on: ubuntu-latest
      needs: build
      #if: github.ref == 'refs/heads/master'
      steps:
          - name: Set build number
            id: set-buildnumbe
            run: |
                CURRENTDATE=`date +"%Y.%m.%d"`
                echo "BUILD_NUMBER=${CURRENTDATE}.${{github.run_number}}" >> $GITHUB_ENV

          - name: Create a Release
            id: create_release
            uses: actions/create-release@v1.1.4
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
               tag_name: ${{env.BUILD_NUMBER}}
               release_name: ${{env.BUILD_NUMBER}}
               
          - name: Upload Release Asset
            id: upload-release-asset 
            uses: actions/upload-release-asset@v1.0.2
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{steps.create_release.outputs.upload_url}} 
              asset_path: ${{github.workspace}}\build\
              asset_name: OpenHab UWP App
