name: 'CI'

env:
  releaseName: 'CI_${{github.run_number}}'
  BUILD_NUMBER: '1970.1.1'

on:
  push:
    branches: 
      - master
      - features/*
      - fixes/*
      - releases/* 

jobs:
  build:
    name: 'Build openHAB Windows App'
    runs-on: windows-latest

    steps:
    - name: Checkout master code
      uses: actions/checkout@v1
      with:
        path: src
        clean: true
    
    - name: Update Version Number
      shell: pwsh
      run: | 
            Set-Location '${{github.workspace}}/.github/workflow/scripts/' 
            ./Set-Version.ps1 -SourceDirectory '${{github.workspace}}\' -Major '2021' -Minor '1' -Build '9'

    - name: Printout Version Number
      shell: pwsh
      run: echo 'New Version Number $BUILD_NUMBER'

    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.0.5
      with:
        nuget-version:  'latest'
    
    - name: setup-msbuild
      uses: microsoft/setup-msbuild@v1

    - name: Restore nuget packages
      run: nuget restore ${{github.workspace}}\OpenHAB.Windows.sln
    
    - name: Build OpenHab Windows App
      run: msbuild.exe ${{github.workspace}}\OpenHAB.Windows.sln /p:AppxBundlePlatforms="x86|x64|ARM" /p:AppxPackageDir="${{github.workspace}}\build\" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=StoreUpload /p:configuration="release"

    - name: Upload build assets
      uses: actions/upload-artifact@v2.2.2
      with:
        name: app
        path: ${{github.workspace}}\build\
      
  release:
      name: 'Creates an app release'
      runs-on: windows-latest 
      if: github.ref == 'refs/heads/master'
      steps:
          - name: Create a Release
            id: create_release
            uses: actions/create-release@v1.1.4
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
               tag_name: ${{github.GITHUB_REF}}
               release_name: Release ${{env.releaseName}}
               
          - name: Upload Release Asset
            id: upload-release-asset 
            uses: actions/upload-release-asset@v1.0.2
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{steps.create_release.outputs.upload_url}} 
              asset_path: ${{github.workspace}}\build\
              asset_name: OpenHab UWP App
