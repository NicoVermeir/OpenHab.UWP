name: 'Main'
on: workflow_dispatch

env:
  BUILD_NUMBER: '1970.1.1' 

jobs:
  test:
    name: 'Test job'
    runs-on: ubuntu-latest
    
    steps:
    - name: Set build number
      id: set-buildnumbe
      run: |
           CURRENTDATE=`date +"%Y.%m.%d"`
           echo "BUILD_NUMBER=${CURRENTDATE}" >> $GITHUB_ENV

    - name: Debug output variable
      run: |
           echo "${{ env.BUILD_NUMBER}}"

  build:
    name: 'Build openHAB Windows App'
    runs-on: windows-latest
    needs: test

    steps:
    - name: Checkout master code
      uses: actions/checkout@v1
      with:
        path: src
        clean: true

    # - name: Set build number
    #   id: set-buildnumber
    #   shell: pwsh
    #   run: |
    #        $major= [System.DateTime]::Now.Year
    #        $minor = [System.DateTime]::Now.Month
    #        $build = [System.DateTime]::Now.Day 
    #        $revision = ${{github.run_number}}

    #        $version = "$major.$minor.$build.$revision"
    #        Write-Host "Set version number for build to $version"
    #        echo "BUILD_NUMBER=$($version)" >> $GITHUB_ENV

    - name: Update Version Number in app files
      id: update-packageverion
      shell: pwsh
      run: | 
            Set-Location '${{github.workspace}}\.github\workflows\scripts'
             $major= [System.DateTime]::Now.Year
             $minor = [System.DateTime]::Now.Month
             $build = [System.DateTime]::Now.Day

            ./Set-Version.ps1 -SourceDirectory '${{github.workspace}}\' -Major $major -Minor $minor -Build $build -Revision 0 -SetVersion
         
    - name: Setup NuGet.exe for use with actions
      uses: NuGet/setup-nuget@v1.0.5
      with:
        nuget-version:  'latest'
    
    - name: setup-msbuild
      uses: microsoft/setup-msbuild@v1

    - name: Restore nuget packages
      run: nuget restore ${{github.workspace}}\OpenHAB.Windows.sln
    
    - name: Build OpenHab Windows App
      run: msbuild.exe ${{github.workspace}}\OpenHAB.Windows.sln /p:AppxBundlePlatforms="x86|x64|ARM" /p:AppxPackageDir="${{github.workspace}}\build\" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=StoreUpload /p:configuration="release"

    - name: Upload build assets
      uses: actions/upload-artifact@v2.2.2
      with:
        name: app
        path: ${{github.workspace}}\build\
      
  release:
      name: 'Creates an app release'
      runs-on: ubuntu-latest
      needs: build
      #if: github.ref == 'refs/heads/master'
      steps:
          - name: Set build number
            id: set-buildnumbe
            run: |
                CURRENTDATE=`date +"%Y.%m.%d"`
                echo "BUILD_NUMBER=${CURRENTDATE}.${{github.run_number}}" >> $GITHUB_ENV

          - name: Create a Release
            id: create_release
            uses: actions/create-release@v1.1.4
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
               tag_name: ${{env.BUILD_NUMBER}}
               release_name: ${{env.BUILD_NUMBER}}
               
          - name: Upload Release Asset
            id: upload-release-asset 
            uses: actions/upload-release-asset@v1.0.2
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{steps.create_release.outputs.upload_url}} 
              asset_path: ${{github.workspace}}\build\
              asset_name: OpenHab UWP App
